<!DOCTYPE html>
<html lang="en">
<head>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" type="text/css" href="http://jonnyreeves.co.uk/theme/css/style.min.css">
  <link rel="stylesheet" type="text/css" href="http://jonnyreeves.co.uk/theme/css/pygments.min.css">
  <link rel="stylesheet" type="text/css" href="http://jonnyreeves.co.uk/theme/css/font-awesome.min.css">
  <link href="http://jonnyreeves.co.uk/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Jonny Reeves Atom">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />
  <meta name="author" content="Jonny Reeves" />
  <meta name="description" content="" />
<meta property="og:site_name" content="Jonny Reeves"/>
<meta property="og:type" content="blog"/>
<meta property="og:title" content="Jonny Reeves"/>
<meta property="og:description" content=""/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="http://jonnyreeves.co.uk"/>
<meta property="og:image" content="/images/avatar.jpg">
  <title>Jonny Reeves</title>
</head>
<body>
  <aside>
    <div>
      <a href="http://jonnyreeves.co.uk">
        <img src="/images/avatar.jpg" alt="Jonny Reeves" title="Jonny Reeves">
      </a>
      <h1><a href="http://jonnyreeves.co.uk">Jonny Reeves</a></h1>
      <p>code && coffee || music</p>
      <nav>
        <ul class="list">
        </ul>
      </nav>
      <ul class="social">
        <li><a class="sc-linkedin" href="https://br.linkedin.com/in/jonnyreeves/en" target="_blank"><i class="fa fa-linkedin"></i></a></li>
        <li><a class="sc-google" href="https://plus.google.com/+JohnReeves" target="_blank"><i class="fa fa-google"></i></a></li>
        <li><a class="sc-stack-overflow" href="http://stackoverflow.com/users/227349/jonnyreeves" target="_blank"><i class="fa fa-stack-overflow"></i></a></li>
        <li><a class="sc-github" href="https://github.com/jonnyreeves" target="_blank"><i class="fa fa-github"></i></a></li>
      </ul>
    </div>
  </aside>
  <main>

<article>
  <header>
    <h2><a href="http://jonnyreeves.co.uk/2016/shrinkwrap-your-npm-dependencies/#shrinkwrap-your-npm-dependencies">Shrinkwrap your NPM Dependencies</a></h2>
    <p>
      Posted on Mon 04 January 2016 in <a href="http://jonnyreeves.co.uk/category/javascript.html">JavaScript</a>
      &#8226; <a href="http://jonnyreeves.co.uk/2016/shrinkwrap-your-npm-dependencies/#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>Things move a little too quickly in the NPM ecosystem for my liking at times, modules updates can turn a working project into a broken build with a single <code>npm install</code>; this is especially bad news if your <a href="https://en.wikipedia.org/wiki/Continuous_integration">Continuous Integration</a> server is pulling your NPM dependencies with each build.  Sometimes this can be the result of human error, other times it can be even <a href="https://github.com/rackt/react-router/issues/2195">more confusing</a> leading to a lot of wasted effort in your team.</p>
<p>One way to bring order is to make use of <a href="https://docs.npmjs.com/cli/shrinkwrap"><code>npm shrinkwrap</code></a> which pins your project's <code>node_modules</code> at fixed revisions ensuring that you get the exact same dependency graph each time you <code>npm install</code>.  One major benefit of this approach is that you can safely cache and re-use your node_modules folder between CI builds which should dramatically decrease your pull-request build times.</p>
<p>There are however a couple of downsides, the main one being that you can no longer just <code>npm install</code> as NPM will not update <code>npm-shrinkwrap.json</code> (so your teammates / CI server won't fetch it), instead you need to go through the following dance and then commit both <code>package.json</code> and <code>npm-shrinkwrap.json</code> files.</p>
<div class="highlight"><pre>npm install --save my-dep
npm dedupe
npm shrinkwrap
</pre></div>


<p>You may wish to consider <a href="https://github.com/uber/npm-shrinkwrap">uber/npm-shrinkwrap</a> which looks like it helps streamline the process somewhat.</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://jonnyreeves.co.uk/2015/mysql-getting-killed-on-low-end-vps/#mysql-getting-killed-on-low-end-vps">MySQL Getting Killed on Low-end VPS</a></h2>
    <p>
      Posted on Fri 11 December 2015 in <a href="http://jonnyreeves.co.uk/category/devops.html">DevOps</a>
      &#8226; <a href="http://jonnyreeves.co.uk/2015/mysql-getting-killed-on-low-end-vps/#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>My wife's blog is powered by Wordpress running on a <a href="https://www.bhost.net/">bHost Tiny VPS</a> instance (1GB RAM) using a combination of MariaDB, Nginx and php-fpm.  Thanks to <a href="https://en-gb.wordpress.org/plugins/wp-super-cache/">WP Super Cache</a>; the site is pretty responsive.</p>
<p>Things had been going pretty well for the last couple of months until she told me that the site was broken; turns out the the MariaDB instance (mysqld) had stopped... odd.</p>
<p>First port of call was the logs, tailing <code>/var/log/mariadb/mariadb.log</code> showed that the process was being periodically killed and restarted - however there was no mention of why it died, the last log entry was:</p>
<div class="highlight"><pre><span class="nv">$ </span>tail -n <span class="m">1</span> /var/log/mariadb/mariadb.log
<span class="m">151211</span> 19:01:18 mysqld_safe mysqld from pid file /var/run/mariadb/mariadb.pid e<span class="err">$</span>
</pre></div>


<p>Upon restarting it (via <code>service mariadb start</code>), the logs were appended with the following:</p>
<div class="highlight"><pre><span class="nv">$ </span>tail /var/log/mariadb/mariadb.log
<span class="m">151211</span> 20:33:33 mysqld_safe Starting mysqld daemon with databases from /var/lib<span class="err">$</span>
<span class="m">151211</span> 20:33:33 <span class="o">[</span>Note<span class="o">]</span> /usr/libexec/mysqld <span class="o">(</span>mysqld 5.5.44-MariaDB<span class="o">)</span> starting as <span class="err">$</span>
InnoDB: Log scan progressed past the checkpoint lsn 55316603
<span class="m">151211</span> 20:33:34  InnoDB: Database was not shut down normally!
InnoDB: Starting crash recovery.
</pre></div>


<p>It's clear that whatever is killing the database is not doing so cleanly.  <code>dmesg</code> can be used to search all logs and try to shed some light:</p>
<div class="highlight"><pre><span class="nv">$ </span>dmesg <span class="p">|</span> egrep -i <span class="s1">&#39;killed process&#39;</span>
<span class="o">[</span>4038014.625029<span class="o">]</span> Out of memory in UB XXXX: OOM killed process <span class="m">601</span> <span class="o">(</span>mysqld<span class="o">)</span> score <span class="m">0</span> vm:1212112kB, rss:84964kB, swap:748kB
</pre></div>


<p>Ah, that's not good.  The <a href="http://linux-mm.org/OOM_Killer">OOM Killer</a> is choosing to sacrifice mysqld; although not the best choice it's clear that there's something bigger going on that needs to be addressed.</p>
<p>Now I know the problem is related to low memory, let's see how much free memory we currently have available:</p>
<div class="highlight"><pre><span class="nv">$ </span>free -m
            total        used        free      shared  buff/cache   available
Mem:         <span class="m">1024</span>         <span class="m">764</span>           <span class="m">7</span>          <span class="m">10</span>         <span class="m">251</span>         11
Swap:           <span class="m">0</span>           <span class="m">0</span>           0
</pre></div>


<p>7MB free... oh dear.  So what's using up all the memory? We can find out using <code>ps</code></p>
<div class="highlight"><pre><span class="nv">$ </span>ps aux --sort<span class="o">=</span>-%mem <span class="p">|</span> awk <span class="s1">&#39;NR&lt;=10{print $0}&#39;</span>
USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root       <span class="m">980</span>  1.5  1.8 <span class="m">781612</span> <span class="m">19128</span> ?        Ssl  Dec10  21:22 /usr/sbin/rsyslogd -n
root     <span class="m">17069</span>  0.0  1.1 <span class="m">307316</span> <span class="m">11804</span> ?        Ss   19:37   0:00 php-fpm: master process <span class="o">(</span>/etc/php-fpm.conf<span class="o">)</span>
root        <span class="m">72</span>  0.0  1.0 <span class="m">237836</span> <span class="m">10496</span> ?        Ss   Dec10   0:26 /usr/lib/systemd/systemd-journald
nginx    <span class="m">22205</span>  1.0  4.7 <span class="m">307448</span>  <span class="m">7264</span> ?        S    20:19   0:00 php-fpm: pool www
nginx    <span class="m">22551</span>  1.0  4.4 <span class="m">307448</span>  <span class="m">7661</span> ?        S    20:29   0:00 php-fpm: pool www
nginx    <span class="m">22445</span>  1.0  4.7 <span class="m">307448</span>  <span class="m">5671</span> ?        S    20:20   0:00 php-fpm: pool www
nginx    <span class="m">22041</span>  1.0  4.3 <span class="m">307448</span>  <span class="m">7511</span> ?        S    20:12   0:00 php-fpm: pool www
nginx    <span class="m">17190</span>  0.0  0.3 <span class="m">109980</span>  <span class="m">3524</span> ?        S    20:38   0:00 nginx: worker process
</pre></div>


<p>And the culprit is <code>php-fpm</code>! A quick google found another Wordpress customer <a href="https://wordpress.org/support/topic/php-fpm-for-wordpress-gobbling-up-memory">suffering from similar symptoms</a>; the advice was to tweak the php-fpm pool configuration (<code>/etc/php-fpm.d/www.conf</code>) and tweak the <code>pm</code> configuration.  The main change was to move from <code>pm = dynamic</code> to <code>pm = ondemand</code> with a <code>pm.max_children</code> value of <code>5</code> (based on observing ~5% memory usage per worker).  After changing the configuration I restarted all services and checked the memory usage.</p>
<div class="highlight"><pre><span class="nv">$ </span>service php-fpm restart
<span class="nv">$ </span>service nginx restart
<span class="nv">$ </span>service mariadb restart
</pre></div>


<p>After restarting the memory usage was dramatically lower:</p>
<div class="highlight"><pre><span class="nv">$ </span>free -m
              total        used        free      shared  buff/cache   available
Mem:           <span class="m">1024</span>          <span class="m">96</span>         <span class="m">677</span>           <span class="m">7</span>         <span class="m">250</span>         830
Swap:             <span class="m">0</span>           <span class="m">0</span>           0
</pre></div>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://jonnyreeves.co.uk/2015/dont-always-npm-install-g/#dont-always-npm-install-g">Don't (always) npm install -g</a></h2>
    <p>
      Posted on Thu 26 November 2015 in <a href="http://jonnyreeves.co.uk/category/javascript.html">JavaScript</a>
      &#8226; <a href="http://jonnyreeves.co.uk/2015/dont-always-npm-install-g/#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>Had a chat with a respected hacker friend of mine who did not know about this trick (although to be fair, I'm not sure I knew about it until all that long ago).</p>
<p>There's almost never any need to use <code>npm install -g</code>, you could argue it's an anti-pattern as it makes your software harder to install for other users and can easily cause conflcits between projects.  The most common candidates for a bit of global installing are test and build utils like mocha, typescript and grunt-cli; instead of reaching for <code>-g</code> you can install them locally in your project and execute them from the symlink created in <code>node_modules/.bin</code>, eg:</p>
<div class="highlight"><pre>npm install --save-dev mocha
./node_modules/.bin/mocha --help
</pre></div>


<p>You can also make use of the <code>npm bin</code> command which will resolve the nearest <code>node_modules/.bin</code> path to the cwd:</p>
<div class="highlight"><pre>`npm bin`/mocha --help
</pre></div>


<p>As an added bonus, NPM scripts don't need to add the <code>node_modules/.bin</code> prefix - it's added automatically:</p>
<div class="highlight"><pre><span class="p">{</span>
  <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;my-awesome-pkg&quot;</span><span class="p">,</span>
  <span class="nt">&quot;scripts&quot;</span><span class="p">:</span> <span class="p">{</span>
    <span class="nt">&quot;test&quot;</span><span class="p">:</span> <span class="s2">&quot;mocha&quot;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://jonnyreeves.co.uk/2015/testing-querystrings-in-httprequest/#testing-querystrings-in-httprequest">Testing QueryStrings in http.Request</a></h2>
    <p>
      Posted on Sat 14 November 2015 in <a href="http://jonnyreeves.co.uk/category/golang.html">Golang</a>
      &#8226; <a href="http://jonnyreeves.co.uk/2015/testing-querystrings-in-httprequest/#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>This one threw me; say you have a subject that reads a value from an HTTP Request's Query, something like this:</p>
<div class="highlight"><pre><span class="kd">func</span> <span class="nx">ValidateState</span><span class="p">(</span><span class="nx">req</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="nx">fwdState</span> <span class="o">:=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Query</span><span class="p">().</span><span class="nx">Get</span><span class="p">(</span><span class="s">&quot;state&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">fwdState</span> <span class="o">!=</span><span class="p">=</span> <span class="s">&quot;expected&quot;</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;Unexpected state value: %s&quot;</span><span class="p">,</span> <span class="nx">fwdState</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">nil</span>
<span class="p">}</span>
</pre></div>


<p>In order to test this method, you'll want to create an <code>http.Request</code> instead and pre-populate the QueryString.  My first attempt was the reverse how we read the Query value:</p>
<div class="highlight"><pre><span class="kd">func</span> <span class="nx">Test_ValidateState</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">req</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">{</span><span class="nx">URL</span><span class="p">:</span><span class="o">&amp;</span><span class="nx">url</span><span class="p">.</span><span class="nx">URL</span><span class="p">{}}</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Query</span><span class="p">().</span><span class="nx">Set</span><span class="p">(</span><span class="s">&quot;state&quot;</span><span class="p">,</span> <span class="s">&quot;expected&quot;</span><span class="p">)</span>
    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ValidateState</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span>
    <span class="nx">require</span><span class="p">.</span><span class="nx">NoError</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>


<p>However, this fails with the <code>ValidateState</code> function returning an <code>"Unexepcted state value: "</code> error.  Instead, we need to set the <code>Request.URL.RawQuery</code> value directly:</p>
<div class="highlight"><pre><span class="kd">func</span> <span class="nx">Test_ValidateState</span><span class="p">(</span><span class="nx">t</span> <span class="o">*</span><span class="nx">testing</span><span class="p">.</span><span class="nx">T</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">req</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">{</span><span class="nx">URL</span><span class="p">:</span><span class="o">&amp;</span><span class="nx">url</span><span class="p">.</span><span class="nx">URL</span><span class="p">{}}</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">RawQuery</span> <span class="p">=</span> <span class="s">&quot;state=expected&quot;</span>
    <span class="nx">err</span> <span class="o">:=</span> <span class="nx">ValidateState</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span>
    <span class="nx">require</span><span class="p">.</span><span class="nx">NoError</span><span class="p">(</span><span class="nx">t</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://jonnyreeves.co.uk/2015/live-reloading-in-express/#live-reloading-in-express">Live Reloading in Express</a></h2>
    <p>
      Posted on Sat 31 October 2015 in <a href="http://jonnyreeves.co.uk/category/javascript.html">JavaScript</a>
      &#8226; <a href="http://jonnyreeves.co.uk/2015/live-reloading-in-express/#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>Gaffa tape time.  Getting iteration times down is important when building software, if nothing else it makes it more fun and help you keep the flow going.  With this in mind, let's get live reloading working with <a href="https://github.com/janl/mustache.js/">Mustache templates</a> on an <a href="https://www.npmjs.com/package/express">express</a>-based local development server.</p>
<p>Let's start simple by serving some templates:</p>
<div class="highlight"><pre><span class="kr">import</span> <span class="nx">express</span> <span class="nx">from</span> <span class="s1">&#39;express&#39;</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">mustache</span> <span class="nx">from</span> <span class="s1">&#39;mustache&#39;</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">fs</span> <span class="nx">from</span> <span class="s1">&#39;fs&#39;</span><span class="p">;</span>

<span class="c1">// Create a new express server instance.</span>
<span class="kr">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>

<span class="c1">// Handle GET requests to `/hello`.</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;/hello&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="c1">// Read the template and JSON data from the local filesystem.</span>
  <span class="kr">const</span> <span class="nx">tpl</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s1">&#39;./hello.mustache&#39;</span><span class="p">,</span> <span class="s1">&#39;utf8&#39;</span><span class="p">);</span>
  <span class="kr">const</span> <span class="nx">data</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s1">&#39;./hello.json&#39;</span><span class="p">));</span>

  <span class="c1">// Serve back the rendered template.</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">mustache</span><span class="p">.</span><span class="nx">render</span><span class="p">(</span><span class="nx">tpl</span><span class="p">,</span> <span class="nx">data</span><span class="p">));</span>
<span class="p">});</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="err">`</span><span class="nx">server</span> <span class="nx">started</span> <span class="nx">at</span> <span class="nx">http</span><span class="o">:</span><span class="c1">//localhost:3000`);</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="mi">3000</span><span class="p">);</span>
</pre></div>


<p>So far so good, but let's make it live-reload so we can do this:</p>
<p><a href="https://gyazo.com/326ca72b98bce37af177d9e8d5143279"><img alt="https://gyazo.com/326ca72b98bce37af177d9e8d5143279" src="https://i.gyazo.com/326ca72b98bce37af177d9e8d5143279.gif" /></a></p>
<p>First stop is to grab the <a href="https://www.npmjs.com/package/livereload">livereload module</a> from NPM; this creates its own server which serves a javascript file used for relaying changes back to the browser; it also sets up a file-system monitor to detect changes when you modify your source files.</p>
<div class="highlight"><pre><span class="c1">// Create a livereload server</span>
<span class="kr">const</span> <span class="nx">reloadServer</span> <span class="o">=</span> <span class="nx">livereload</span><span class="p">.</span><span class="nx">createServer</span><span class="p">({</span>
  <span class="c1">// Reload on changes to these file extensions.</span>
  <span class="nx">exts</span><span class="o">:</span> <span class="p">[</span> <span class="s1">&#39;json&#39;</span><span class="p">,</span> <span class="s1">&#39;mustache&#39;</span> <span class="p">],</span>
  <span class="c1">// Print debug info</span>
  <span class="nx">debug</span><span class="o">:</span> <span class="kc">true</span>
<span class="p">});</span>

<span class="c1">// Specify the folder to watch for file-changes.</span>
<span class="nx">reloadServer</span><span class="p">.</span><span class="nx">watch</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">);</span>
</pre></div>


<p>The last piece is to inject the <code>livereload.js</code> into your HTML; the <a href="https://github.com/intesso/connect-livereload">connect-livereload module</a> takes care of this; just drop it into your app before your define your routes:</p>
<div class="highlight"><pre><span class="c1">// Inject the livereload.js script tag into pages.</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">livereloadMiddleware</span><span class="p">());</span>
</pre></div>


<p>Et viola, live reloading of mustache templates and their associated data.  Full source over on <a href="https://github.com/jonnyreeves/mustache-express-hotreload">github</a>.</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://jonnyreeves.co.uk/2015/babel-npm/#babel-npm">Babel ‚ù§ NPM</a></h2>
    <p>
      Posted on Sat 24 October 2015 in <a href="http://jonnyreeves.co.uk/category/javascript.html">JavaScript</a>
      &#8226; <a href="http://jonnyreeves.co.uk/2015/babel-npm/#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>Once you go ES6, you never go back ;)  In order to create ES5-backwards-compatible modules, there's are a few nuances that you need to be aware of:</p>
<h3>babelify</h3>
<p>Transpiling your NPM modules to ES5 with <a href="https://babeljs.io/">babel</a> will allow them to work in a wide variety of environments.  Add a <code>prepublish</code> script to your <code>package.json</code>'s scripts block to automate this when you run <code>npm publish</code>.  By convention <code>/lib</code> is a good place to output your ES5 artefacts to, and it's a good idea to produce a clean build each time (with the <a href="https://www.npmjs.com/package/rimraf">rimraf module</a> providing a cross platform implementation of <code>rm -rf</code>, windows users will thank you.)</p>
<h6><code>/package.json</code></h6>
<div class="highlight"><pre>{
  &quot;name&quot;: &quot;my_pkg&quot;,
  &quot;scripts&quot;: {
    &quot;prepublish&quot;: &quot;rimraf lib &amp;&amp; babel --out-dir lib src&quot;
  }
}
</pre></div>


<h3>main</h3>
<p>Traditionally your <code>index.js</code> file would reside in the root of your module (this is where NPM will look for it by default); however as we are going to transpile to ES5 you'll want to put your index file, and all other ES6 sources under <code>/src</code>.</p>
<p>Your <code>package.json</code>'s <code>main</code> block should point to the transpiled <code>index.js</code> file in the <code>/lib</code> folder.  If you're feeling adventurous you incude a <a href="https://github.com/caridy/es6-module-transpiler-npm-resolver"><code>jsnext:main</code></a> block and point to to your ES6 entry point.</p>
<h6><code>/package.json</code></h6>
<div class="highlight"><pre>{
  &quot;name&quot;: &quot;my_pkg&quot;,
  &quot;main&quot;: &quot;lib/index.js&quot;,
  &quot;jsnext:main&quot;: &quot;src/index.js&quot;
}
</pre></div>


<h2>Mocha</h2>
<p>Mocha does the job well and it's easy to configure for use with babel; just give it a <code>--compilers</code> flag when you invoke it:</p>
<h6><code>/package.json</code></h6>
<div class="highlight"><pre>{
  &quot;name&quot;: &quot;my_pkg&quot;,
  &quot;scripts&quot;: {
    &quot;test&quot;: &quot;mocha --compilers js:babel/register --recursive&quot;
  }
}
</pre></div>


<h2>.npmignore</h2>
<p>This one tripped me up; when I published my first NPM modules which made use of babel (<a href="https://github.com/jonnyreeves/redux-action-side-effects">redux-action-side-effects</a>) my <code>/lib</code> folder wasn't included in the final archived vended by NPM.  Turns out that NPM will <a href="https://docs.npmjs.com/misc/developers#keeping-files-out-of-your-package">automatically exclude everything in your <code>.gitignore</code> file</a> (and as the <code>/lib</code> folder contains build artefacts I excluded it from source control).  To override this add a <code>/.npmignore</code> file:</p>
<h5><code>/.npmignore</code></h5>
<div class="highlight"><pre># If this file is not present the contents of .gitignore are used
/.gitignore
</pre></div>


<p>Happy <code>npm publish</code>ing!</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://jonnyreeves.co.uk/2015/mocking-xmlhttprequests-in-jasmine/#mocking-xmlhttprequests-in-jasmine">Mocking XMLHttpRequests in Jasmine</a></h2>
    <p>
      Posted on Mon 19 October 2015 in <a href="http://jonnyreeves.co.uk/category/javascript.html">javascript</a>
      &#8226; <a href="http://jonnyreeves.co.uk/2015/mocking-xmlhttprequests-in-jasmine/#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>When writing integration tests, it's often useful to fake network requests so your tests can be predictable and execute quickly.  Jasmine provides <a href="https://github.com/jasmine/jasmine-ajax"><code>jasmine-ajax</code></a> which will replace the <code>XMLHttpRequest</code> constructor on the global (eg: <code>window</code>).</p>
<p>Wiring up jasmine.Ajax into your test-suites' lifecycle is pretty straight forward:</p>
<div class="highlight"><pre><span class="kr">import</span> <span class="s1">&#39;jasmine-ajax&#39;</span><span class="p">;</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;myTestSuite&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">beforeEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">jasmine</span><span class="p">.</span><span class="nx">Ajax</span><span class="p">.</span><span class="nx">install</span><span class="p">());</span>
  <span class="nx">afterEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">jasmine</span><span class="p">.</span><span class="nx">Ajax</span><span class="p">.</span><span class="nx">uninstall</span><span class="p">());</span>
<span class="p">});</span>
</pre></div>


<p>As per the <a href="http://jasmine.github.io/2.0/ajax.html">docs</a>, you can then pre-program responses before your subject under test makes them:</p>
<div class="highlight"><pre><span class="nx">jasmine</span><span class="p">.</span><span class="nx">Ajax</span><span class="p">.</span><span class="nx">stubRequest</span><span class="p">(</span><span class="s1">&#39;http://example.org/api&#39;</span><span class="p">)</span>
  <span class="p">.</span><span class="nx">andReturn</span><span class="p">({</span> <span class="nx">responseText</span><span class="o">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span> <span class="nx">json</span><span class="o">:</span> <span class="s1">&#39;ok!&#39;</span> <span class="p">})</span> <span class="p">});</span>
</pre></div>


<p>jasmine-ajax executes all XHR callbacks on the same tick making them effectivly syncronous.  This results in your test-code much easier to write and reason about.</p>
<h3>Pairing with <code>xhr</code></h3>
<p><code>XMLHttpRequest</code> doesn't have the nicest API to work with; fortunatley the <a href="https://github.com/Raynos/xhr"><code>xhr</code></a> module on NPM provides a nice, lightweight abstraction (it even smooths out the cracks in IE8).  However, it's not all plain sailing as the xhr module caches the <code>XMLHttpRequest</code> object on the window when it is loaded (ie: <code>require()</code>'d).</p>
<div class="highlight"><pre><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="p">.</span><span class="nx">XMLHttpRequest</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">XMLHttpRequest</span><span class="p">;</span>
</pre></div>


<p>This results in requests made using the <code>xhr</code> module ignorning the fake <code>XMLHttpRequest</code> constructor that <code>jasmine-ajax</code> has placed on the window.  Fortunatley there's an easy fix, just re-assign <code>xhr.XMLHttpRequest</code> after you've installed jasmine-ajax:</p>
<div class="highlight"><pre><span class="kr">import</span> <span class="s1">&#39;jasmine-ajax&#39;</span><span class="p">;</span>
<span class="kr">import</span> <span class="nx">xhr</span> <span class="nx">from</span> <span class="s1">&#39;xhr&#39;</span><span class="p">;</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">&#39;myTestSuite&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">beforeEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">jasmine</span><span class="p">.</span><span class="nx">Ajax</span><span class="p">.</span><span class="nx">install</span><span class="p">();</span>
    <span class="nx">xhr</span><span class="p">.</span><span class="nx">XMLHttpRequest</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">XMLHttpRequest</span><span class="p">;</span>
  <span class="p">});</span>
  <span class="nx">afterEach</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">jasmine</span><span class="p">.</span><span class="nx">Ajax</span><span class="p">.</span><span class="nx">uninstall</span><span class="p">();</span>
    <span class="nx">xhr</span><span class="p">.</span><span class="nx">XMLHttpRequest</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">XMLHttpRequest</span><span class="p">;</span>
  <span class="p">});</span>
<span class="p">});</span>
</pre></div>


<h3>Closing thoughts on Jasmine</h3>
<p>I've recently switched to Jasmine after using Mocha and SinonJS succesfully for a few years.  My hope was that the Jasmine ecosystem, which has a lot of funtionality built-in, would be more productive and easier for new-comers to the project to pick up than Mocha.  I've been very impressed by how easy it was to get up and running on Jasmine; and the v2.3 API is pleasant to code against (it will be instantly familiar to <a href="http://chaijs.com/guide/installation/">chai</a> users), however I do wish that Jasmine made it easier to write custom matchers as I find myself missing the verbosity of SinonJS's <code>sinon.match(val =&gt; { ... })</code>.</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://jonnyreeves.co.uk/2015/single-page-app-versioning/#single-page-app-versioning">Single Page App Versioning</a></h2>
    <p>
      Posted on Sat 26 September 2015 in <a href="http://jonnyreeves.co.uk/category/misc.html">misc</a>
      &#8226; <a href="http://jonnyreeves.co.uk/2015/single-page-app-versioning/#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>Versioning applications isn't quite as clear cut as <a href="http://semver.org/">versioning libraries</a>; individuals on teams will almost certainly fork the codebase to work on features (sometimes long-lived) but you will still want to provide an easy, and consistent way to refer to each build generated from your Continuous Integration system.</p>
<p>My preferred approach combines the human managed semantic version number from a project's <code>package.json</code> file with the short commit hash; ie: <code>0.1.6-deff00</code>; you can configure your project's build system to replace the commit hash for local (non-ci) builds.  This also has the nice advantage of making each build traceable back to your project's Git repository should you forget to tag a build :)</p>
<p>The following example is for <a href="https://webpack.github.io/">webpack</a>, but could easily be modified for any build system:</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">webpack</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;webpack&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">gitrev</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;git-rev-sync&#39;</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">pkg</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;./package.json&#39;</span><span class="p">)</span>

<span class="kd">function</span> <span class="nx">version</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">pkg</span><span class="p">.</span><span class="nx">version</span> <span class="o">+</span> <span class="s1">&#39;-&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PRODUCTION</span> <span class="o">?</span> <span class="nx">gitrev</span><span class="p">.</span><span class="kr">short</span><span class="p">()</span> <span class="o">:</span> <span class="s1">&#39;dev&#39;</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
  <span class="cm">/* ... */</span>
  <span class="nx">plugins</span><span class="o">:</span> <span class="p">[</span>
    <span class="k">new</span> <span class="nx">webpack</span><span class="p">.</span><span class="nx">DefinePlugin</span><span class="p">({</span>
      <span class="nx">VERSION</span><span class="o">:</span> <span class="nx">version</span><span class="p">()</span>
    <span class="p">})</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://jonnyreeves.co.uk/2015/getting-proper-stack-traces-with-mocha-and-typescript/#getting-proper-stack-traces-with-mocha-and-typescript">Getting Proper Stack Traces with Mocha and TypeScript</a></h2>
    <p>
      Posted on Thu 20 August 2015 in <a href="http://jonnyreeves.co.uk/category/typescript.html">TypeScript</a>
      &#8226; <a href="http://jonnyreeves.co.uk/2015/getting-proper-stack-traces-with-mocha-and-typescript/#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>Mocha and TypeScript are awesome when everything's working, but when you have a failing test something's not quite right:</p>
<div class="highlight"><pre><span class="p">$</span><span class="nv">npm</span><span class="x"> test</span>

<span class="x">  Calculator</span>
<span class="x">    </span><span class="cp">#</span><span class="nf">add</span><span class="x"></span>
<span class="x">      1) should work</span>


<span class="x">  0 passing (21ms)</span>
<span class="x">  1 failing</span>

<span class="x">  1) Calculator </span><span class="cp">#</span><span class="nf">add</span><span class="x"> should work:</span>

<span class="x">      AssertionError: expected 6 to equal 7</span>
<span class="x">      + expected - actual</span>

<span class="x">      -6</span>
<span class="x">      +7</span>

<span class="x">      at Context.&lt;anonymous&gt; (test/Calculator.spec.js:12:38)</span>
</pre></div>


<p>The stacktrace at the end points us to the failing assertion; however the stacktrace is pointing <code>Calculator.spec.js</code> - not our TypeScript test-case.  </p>
<p>The TypeScript compiler (<code>tsc</code>) will generate <a href="http://www.html5rocks.com/en/tutorials/developertools/sourcemaps/">source maps</a> to enable debugging the TypeScript source rather than the transpiled ES5 javascript which gets written out by the compiler.  We can enable this with the <code>--sourcemap</code> flag.</p>
<p>Problem is that V8 (the engine that powers Node) doesn't use these sourcemaps when generating stacktraces; <a href="https://github.com/evanw/node-source-map-support">source-map-support</a> to the rescue!  We can enable it by passing <code>--require source-map-support/register</code> to <code>mocha</code>:</p>
<div class="highlight"><pre>{
    &quot;scripts&quot;: {
      &quot;test&quot;: &quot;mocha --require source-map-support/register test/**/*.spec.js&quot;
    }
}
</pre></div>


<p>Now we get an accurate stacktrace on failure :)</p>
<div class="highlight"><pre>  1) Calculator #add should work:

      AssertionError: expected 6 to equal 7
      + expected - actual

      -6
      +7

      at Context.&lt;anonymous&gt; (test/Calculator.spec.ts:15:22)
</pre></div>


<p>Thanks to redditor <a href="https://www.reddit.com/user/pieeta">pieeta</a> who tipped me off :)  I've posted the sample project up on <a href="https://github.com/jonnyreeves/mocha-typescript-stacktraces">Github</a>.</p>
  </div>
  <hr />
</article>
<article>
  <header>
    <h2><a href="http://jonnyreeves.co.uk/2015/using-chai-with-typescript-and-mocha/#using-chai-with-typescript-and-mocha">Using Chai with TypeScript and Mocha</a></h2>
    <p>
      Posted on Fri 14 August 2015 in <a href="http://jonnyreeves.co.uk/category/typescript.html">TypeScript</a>
      &#8226; <a href="http://jonnyreeves.co.uk/2015/using-chai-with-typescript-and-mocha/#disqus_thread">Leave a comment</a>
    </p>
  </header>
  <div>
      <p>Continuing my work on <a href="/2015/injecting-into-constructors-with-typescript-decorators/">Decorator-drive dependency injection in Typescript</a> I've overhauled the tests by replacing the manual assertions with <a href="http://chaijs.com/">chai</a>.  Chai provides a fluent api for writing descriptive assertions - there are a couple of different flavours, personally I feel the <a href="http://chaijs.com/guide/styles/"><code>expect</code></a> style pairs well with TypeScript as I'm not a fan of extending <code>Object.prototype</code>.</p>
<p>Installation is straight forward. First install <code>chai</code> as a dev dependency:</p>
<div class="highlight"><pre>npm install chai --save-dev
</pre></div>


<p>Next grab the <code>d.ts</code> file for chai via <a href="http://definitelytyped.org/tsd/"><code>tsd</code></a> to obtain the type definitions.</p>
<div class="highlight"><pre>tsd install chai --save
</pre></div>


<p>You can now start refactoring your test cases; given the following simple mocha test-case:</p>
<div class="highlight"><pre>describe(&#39;Calculator&#39;, () =&gt; {
  it(&#39;should add two numbers&#39;, () =&gt; {
    const calc : Calculator = new Calculator();

    // Manual assertion.
    if (calc.add(5, 3) !== 8) {
      throw new Error(&#39;expected 5 + 3 to equal 8&#39;);
    }
  });
});
</pre></div>


<p>We can leverage chai's expect method to perform the assertion:</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="p">{</span> <span class="n">expect</span> <span class="p">}</span> <span class="kn">from</span> <span class="s">&#39;chai&#39;</span><span class="p">;</span>

<span class="n">describe</span><span class="p">(</span><span class="s">&#39;Calculator&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="n">it</span><span class="p">(</span><span class="s">&#39;should add two numbers&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="n">const</span> <span class="n">calc</span> <span class="p">:</span> <span class="n">Calculator</span> <span class="o">=</span> <span class="n">new</span> <span class="n">Calculator</span><span class="p">();</span>

    <span class="o">//</span> <span class="n">Chai</span> <span class="n">assertion</span><span class="o">.</span>
    <span class="n">expect</span><span class="p">(</span><span class="n">calc</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="o">.</span><span class="n">equal</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span>
</pre></div>


<p>When running the tests, chai will provide a useful error message should the assertion fail:</p>
<div class="highlight"><pre>1 failing

  1) Calculator should add two numbers:

      AssertionError: expected 6 to equal 8
      + expected - actual

      -8
      +6

      at Context.&lt;anonymous&gt; (test/Calculator.spec.js:26:45)
</pre></div>


<p>Check out <a href="https://github.com/jonnyreeves/ts-prop-injection/pull/3">this pull request</a> which highlights how I integrated chai into the ts-prop-inject project.</p>
  </div>
</article>

  <div class="pagination">
    <a class="btn" href="http://jonnyreeves.co.uk/index2.html">
      <i class="fa fa-angle-left"></i> Older Posts
    </a>
  </div>

    <footer>
      <p>&copy; Jonny Reeves </p>
<p>Built using <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a></p>    </footer>
  </main>
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-30309890-1', 'auto');
  ga('send', 'pageview');
</script>
<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Jonny Reeves ",
  "url" : "http://jonnyreeves.co.uk",
  "image": "/images/avatar.jpg",
  "description": ""
}
</script><script type="text/javascript">
    var disqus_shortname = 'jonnyreeves';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>
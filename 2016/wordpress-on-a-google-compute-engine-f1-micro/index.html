<!DOCTYPE html>
<html lang="en">
<head>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" type="text/css" href="http://jonnyreeves.co.uk/theme/css/style.min.css">
  <link rel="stylesheet" type="text/css" href="http://jonnyreeves.co.uk/theme/css/pygments.min.css">
  <link rel="stylesheet" type="text/css" href="http://jonnyreeves.co.uk/theme/css/font-awesome.min.css">
  <link href="http://jonnyreeves.co.uk/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Jonny Reeves Atom">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />
<meta name="author" content="Jonny Reeves" />
<meta name="description" content="The cheapest offering on Google's cloud platform is the f1-micro instance. The f1-micro is a shared core machine which provides access to a single, virtualised CPU core (with burst capability to help with sudden load spikes) and a meagre 0.6GB of memory: these specs don't sound great ..." />
<meta name="keywords" content="">
<meta property="og:site_name" content="Jonny Reeves"/>
<meta property="og:title" content="Wordpress on a Google Compute Engine f1-micro"/>
<meta property="og:description" content="The cheapest offering on Google's cloud platform is the f1-micro instance. The f1-micro is a shared core machine which provides access to a single, virtualised CPU core (with burst capability to help with sudden load spikes) and a meagre 0.6GB of memory: these specs don't sound great ..."/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="http://jonnyreeves.co.uk/2016/wordpress-on-a-google-compute-engine-f1-micro/"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2016-10-04 21:00:00+01:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="http://jonnyreeves.co.uk/author/jonny-reeves.html">
<meta property="article:section" content="SysAdmin"/>
<meta property="og:image" content="/images/avatar.jpg">  <title>Jonny Reeves &ndash; Wordpress on a Google Compute Engine f1-micro</title>
</head>
<body>
  <aside>
    <div>
      <a href="http://jonnyreeves.co.uk">
        <img src="/images/avatar.jpg" alt="Jonny Reeves" title="Jonny Reeves">
      </a>
      <h1><a href="http://jonnyreeves.co.uk">Jonny Reeves</a></h1>
      <p>code && coffee || music</p>
      <nav>
        <ul class="list">
        </ul>
      </nav>
      <ul class="social">
        <li><a class="sc-linkedin" href="https://br.linkedin.com/in/jonnyreeves/en" target="_blank"><i class="fa fa-linkedin"></i></a></li>
        <li><a class="sc-google" href="https://plus.google.com/+JohnReeves" target="_blank"><i class="fa fa-google"></i></a></li>
        <li><a class="sc-stack-overflow" href="http://stackoverflow.com/users/227349/jonnyreeves" target="_blank"><i class="fa fa-stack-overflow"></i></a></li>
        <li><a class="sc-github" href="https://github.com/jonnyreeves" target="_blank"><i class="fa fa-github"></i></a></li>
      </ul>
    </div>
  </aside>
  <main>

<article>
  <header>
    <h1 id="wordpress-on-a-google-compute-engine-f1-micro">Wordpress on a Google Compute Engine f1-micro</h1>
    <p>Posted on Tue 04 October 2016 in <a href="http://jonnyreeves.co.uk/category/sysadmin.html">SysAdmin</a></p>
  </header>
  <div>
    <p>The cheapest offering on <a href="https://cloud.google.com/">Google's cloud platform</a> is the f1-micro instance.  The f1-micro is a shared core machine which provides access to a single, virtualised CPU core (with burst capability to help with sudden load spikes) and a meagre 0.6GB of memory: these specs don't sound great, but it turns out you can just about cram a moddest-traffic Wordpress instance on it with a little tweaking - and here's the good news, it'll only set you back Â£50 a year!</p>
<h2>Creating a new Instance</h2>
<p>Head on over to the <a href="https://console.cloud.google.com/start">Google Cloud Console</a> and sign up (Google currently offer a 60 day free trial to sweeten the deal).  Battle your way through the onboarding guide and then head over to the <a href="https://console.cloud.google.com/compute">Google Compute Engine control panel</a>.</p>
<ol>
<li>Click create Instance</li>
<li>Select the region closest to you (ie: US or EU)</li>
<li>Select your machine type (micro 1 shared vCPU)</li>
<li>Choose which distro you want to boot into (I am using Debian Jessie) and change the Boot disk size if desired (although the default, 10GB, is plenty)</li>
<li>Make sure you check the Allow HTTP and Allow HTTPS Traffic checkboxes under Firewall settings.</li>
<li>Click create and wait for Goolge to provision your instance.</li>
</ol>
<p>Once your machine has been provisioned (should only take a couple of minutes) you can connect direct from your browser by clicking the SSH button from the Compute Engine <a href="https://console.cloud.google.com/compute/instances">VM Instance Control Panel</a>.</p>
<p><img alt="Connect via SSH" src="/images/2016/wordpress-google-compute-engine-f1-micro/ssh-access.png" /></p>
<p>You can also click this drop down to setup SSH access from the command line by adding an SSH KeyPair or by using <a href="https://cloud.google.com/sdk/gcloud/">gcloud command line interface</a>.</p>
<h3>Obtaining a Static IP</h3>
<p>By default, Compute Engine instances are assigned an ephemeral IP (meaning that it may change should the instance shutdown); for production websites you need to assign a static IP to your instance so you can point your doman at it; this can be done through the Networking <a href="https://console.cloud.google.com/networking/addresses/list">External IP Addresses Control Panel</a> - you can select a the 'Regional' type selecting the same region where your instance is running (eg: <code>europe-west-1</code>).</p>
<h2>Base LEMP Setup</h2>
<p>The following is based off a stock Debian Jessie install; I make use of Nginx (less CPU and memory intensive then Apache), <a href="https://php-fpm.org/about/">PHP-FPM</a> (connects Nginx and PHP), PHP 5 and MySQL. The following command will install all of the required dependencies:</p>
<div class="highlight"><pre><span></span>$ sudo apt-get install mysql-server nginx php5-fpm php5-mysql php-apc <span class="se">\</span>
    pwgen python-setuptools curl git unzip php5-curl php5-gd php5-intl <span class="se">\</span>
    php-pear php5-imagick php5-mcrypt php5-pspell php5-recode <span class="se">\</span>
    php5-sqlite php5-xmlrpc php5-xsl
</pre></div>


<p>Once installed; you will need to tweak your php-fpm settings, and change the <a href="http://serverfault.com/a/701500/81035"><code>cgi.fix_pathinfo</code></a> setting from <code>1</code> to <code>0</code>:</p>
<div class="highlight"><pre><span></span>$ sudo sed -i <span class="s2">&quot;s/;cgi.fix_pathinfo=1/cgi.fix_pathinfo=0/g&quot;</span> /etc/php5/fpm/php.ini
</pre></div>


<p>You may also want to increase the max upload filesize from the 2MB default:</p>
<div class="highlight"><pre><span></span>$ sudo sed -i <span class="s2">&quot;s/upload_max_filesize =.*/upload_max_filesize = 20/g&quot;</span> /etc/php5/fpm/php.ini
$ sudo sed -i <span class="s2">&quot;s/post_max_size =.*/post_max_size = 20M/g&quot;</span> /etc/php5/fpm/php.ini
</pre></div>


<p>Now configure Nginx's default site by editing <code>/etc/nginx/sites-available/default</code>:</p>
<div class="highlight"><pre><span></span>server {
        listen   80;
        listen   [::]:80 default ipv6only=on;
        root /usr/share/nginx/www;
        index index.php;
    client_max_body_size 20M;

        location / {
                try_files $uri $uri/ /index.php?q=$uri&amp;$args;
        }

        location ~ \.php$ {
                include snippets/fastcgi-php.conf;
                include fastcgi_params;
                fastcgi_split_path_info ^(.+\.php)(/.+)$;
                fastcgi_pass unix:/var/run/php5-fpm.sock;
        }
}
</pre></div>


<p>When you make changes to your configuration, you will need to restart the associated services:</p>
<div class="highlight"><pre><span></span>$ sudo service nginx restart
$ sudo service php5-fpm restart
</pre></div>


<p>This configuration will serve php from <code>/usr/share/nginx/www</code> - drop an <code>index.php</code> file there which invokes <code>phpinfo()</code> and visit your Compute Engine instance's IP address in your browser to confirm that everything has been configured - make sure you delete that file once you're done.</p>
<h2>Wordpress Install</h2>
<p>Now the easy bit :)  Start by grabbing wordpress:</p>
<div class="highlight"><pre><span></span>$ <span class="nb">cd</span> /usr/share/nginx
$ wget https://wordpress.org/latest.tar.gz
$ tar xvf latest.tar.gz <span class="o">&amp;&amp;</span> rm latest.tar.gz
$ mv wordpress www
$ chown -R www-data:www-data
$ chmod -R <span class="m">766</span> ./www/wp-content/uploads
</pre></div>


<p>You can now visit your Compute Engine instance's IP address in your browser and the Wordpress installation script should start; you may want to consider <a href="https://www.digitalocean.com/community/tutorials/how-to-create-a-new-user-and-grant-permissions-in-mysql">creating a MySQL user</a> for wordpress without GRANT and ALTER permissions.</p>
<h3>Enabling Automatic Updates</h3>
<p>Wordpress will automatically install security patches if it has a way to write to the local filesystem; one option is to configure the <code>FS-METHOD</code> constant in your <code>wp-config.php</code> to use <code>direct</code> and grant the permissive permissions on your <code>/usr/share/nginx/www</code> folder; generally speaking this is fine if you only have a single Wordpress installation running on the server, however you may wish to consider setting <code>FS-METHOD</code> to <code>ssh2</code> and <a href="https://www.digitalocean.com/community/tutorials/how-to-configure-secure-updates-and-installations-in-wordpress-on-ubuntu">setting up an SSH key/pair</a>. </p>
<h3>Sending Email</h3>
<p>If you need your Wordpress instance to be able to send email (eg: for a contact form); then you may wish to consider installing the <a href="https://wordpress.org/plugins/wp-mail-smtp/">WP Mail SMTP Plugin</a> which will reconfigure Wordpress to route all mail through an SMTP server (ie: a <a href="https://support.google.com/a/answer/176600?hl=en">GMail account</a>).</p>
<h3>Backups</h3>
<p>If you care about your content, it's essential that you back up both the database and the <code>wp-content</code> folder on a regular basis.  I've personally found the <a href="https://wordpress.org/plugins/backupwordpress/">BackupWordPress</a> plugin does a great job for creating local archives on the sever; these can then be shipped over to Google Drive by using <a href="https://github.com/prasmussen/gdrive">gdrive</a> and cron: don't forget to restore from your backup from time-to-time.</p>
<p>Additionally, you can make use of the <a href="https://console.cloud.google.com/compute/snapshots">Compute Engine Snapshot</a> feature which makes disaster recovery straight-forward.</p>
<h2>Wordpress Hardening</h2>
<p>Because of the limited resources avaliable to your instance, it's possible for qutie meagre Denail of Service (DoS) attacks to peg your server's CPU or even knock it offline (by running out of memory).</p>
<p>In my case, just minutes after I had got gotten Wordpress configured the nginx access.log (<code>/var/log/nginx/access.log</code>) started filling up with the following entries:</p>
<div class="highlight"><pre><span></span>192.69.89.173 - - [02/Oct/2016:21:13:50 +0000] &quot;POST /xmlrpc.php HTTP/1.1&quot; 499 0 &quot;-&quot; &quot;Googlebot/2.1 (+http://www.go
ogle.com/bot.html)&quot;
192.69.89.173 - - [02/Oct/2016:21:13:50 +0000] &quot;POST /xmlrpc.php HTTP/1.1&quot; 499 0 &quot;-&quot; &quot;Googlebot/2.1 (+http://www.go
ogle.com/bot.html)&quot;
</pre></div>


<p>That host was hitting me with ~12 requests per second which was enough to spike my CPU usage and cause significant slow-down.</p>
<p><img alt="CPU Graph" src="/images/2016/wordpress-google-compute-engine-f1-micro/cpu-graph.png" /></p>
<h3>Fail2Ban</h3>
<p><a href="http://www.fail2ban.org/wiki/index.php/Main_Page">Fail2Ban</a> scans your server's log files and can be configured to ban IP addresses based on filters you define.</p>
<p>Start by installing and enabling fail2ban with:</p>
<div class="highlight"><pre><span></span>$ sudo apt-get install fail2ban
</pre></div>


<p>Next create a new filter in <code>/etc/fail2ban/filter.d/wordpress.conf</code></p>
<div class="highlight"><pre><span></span><span class="k">[Definition]</span>
<span class="na">failregex</span> <span class="o">=</span> <span class="s">&lt;HOST&gt;.*POST.*(wp-login\.php|xmlrpc\.php).* (403|499|502)</span>
</pre></div>


<p>Next copy <code>/etc/fail2ban/jail.conf</code> to <code>jail.local</code> and append a new rule:</p>
<div class="highlight"><pre><span></span><span class="k">[wordpress]</span>
<span class="na">enabled</span>  <span class="o">=</span> <span class="s">true</span>
<span class="na">port</span>     <span class="o">=</span> <span class="s">http,https</span>
<span class="na">filter</span>   <span class="o">=</span> <span class="s">wordpress</span>
<span class="na">logpath</span>  <span class="o">=</span> <span class="s">/var/log/nginx/access.log</span>
<span class="na">maxretry</span> <span class="o">=</span> <span class="s">3</span>
<span class="na">bantime</span>  <span class="o">=</span> <span class="s">3600</span>
</pre></div>


<p>This configuration will allow 3 such log entries before banning that IP for 1 hour.</p>
<h3>WP Super Cache</h3>
<p><a href="https://en-gb.wordpress.org/plugins/wp-super-cache/">WP Super Cache plugin</a> is essential for a Wordpress install on a low-end server - installation is straight forward from the Wordpress Admin.</p>
<h3>CloudFlare</h3>
<p>If you don't mind giving up control over your DNS, you can put your install behind <a href="https://www.cloudflare.com/plans/">CloudFlare's free plan</a> which should go some way to reducing the amount of traffic that hits your server.</p>
<h3>Offloading Comments</h3>
<p>Wordpress comments can cause a serious headache for low-end instances as they are the source of a lot of spam and will increase the amount of cache invalidation that needs to occur.  Whilst plugins like <a href="https://en-gb.wordpress.org/plugins/akismet/">Akisment</a> (which comes installed by default) certainly help with the former, external comment platforms like <a href="https://disqus.com/">Disqus</a> integrate seamlessly into Wordpress if you don't mind giving up a bit of control over your content.</p>
  </div>
  <div class="tag-cloud">
    <p>
    </p>
  </div>
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'jonnyreeves';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</article>

    <footer>
      <p>&copy; Jonny Reeves </p>
<p>Built using <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a></p>    </footer>
  </main>
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-30309890-1', 'auto');
  ga('send', 'pageview');
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BlogPosting",
  "name": "Wordpress on a Google Compute Engine f1-micro",
  "headline": "Wordpress on a Google Compute Engine f1-micro",
  "datePublished": "2016-10-04 21:00:00+01:00",
  "dateModified": "",
  "author": {
    "@type": "Person",
    "name": "Jonny Reeves",
    "url": "http://jonnyreeves.co.uk/author/jonny-reeves.html"
  },
  "image": "/images/avatar.jpg",
  "url": "http://jonnyreeves.co.uk/2016/wordpress-on-a-google-compute-engine-f1-micro/",
  "description": "The cheapest offering on Google's cloud platform is the f1-micro instance. The f1-micro is a shared core machine which provides access to a single, virtualised CPU core (with burst capability to help with sudden load spikes) and a meagre 0.6GB of memory: these specs don't sound great ..."
}
</script></body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" type="text/css" href="https://jonnyreeves.co.uk/theme/css/style.min.css">
  <link rel="stylesheet" type="text/css" href="https://jonnyreeves.co.uk/theme/css/pygments.min.css">
  <link rel="stylesheet" type="text/css" href="https://jonnyreeves.co.uk/theme/css/font-awesome.min.css">
  <link href="https://jonnyreeves.co.uk/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Jonny Reeves Atom">
  <link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/images/favicon.ico" type="image/x-icon">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />
<meta name="author" content="Jonny Reeves" />
<meta name="description" content="Expanding upon my last post on Property based Dependency Injection, let's have a look at what we need to do in order to inject into methods - here's what we want to achieve: class Person { private _firstName : string; private _lastName : string; @inject('firstName', 'lastName') setName(first : string, last : string) { this._firstName …" />
<meta name="keywords" content="">
<meta property="og:site_name" content="Jonny Reeves"/>
<meta property="og:title" content="Injecting into Methods with TypeScript Decorators"/>
<meta property="og:description" content="Expanding upon my last post on Property based Dependency Injection, let's have a look at what we need to do in order to inject into methods - here's what we want to achieve: class Person { private _firstName : string; private _lastName : string; @inject('firstName', 'lastName') setName(first : string, last : string) { this._firstName …"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="https://jonnyreeves.co.uk/2015/injecting-into-methods-with-typescript-decorators/"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2015-08-03 21:00:00+01:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="https://jonnyreeves.co.uk/author/jonny-reeves.html">
<meta property="article:section" content="TypeScript"/>
<meta property="og:image" content="/images/avatar.jpg">  <title>Jonny Reeves &ndash; Injecting into Methods with TypeScript Decorators</title>
</head>
<body>
  <aside>
    <div>
      <a href="/">
        <img src="/images/avatar.jpg" alt="Jonny Reeves" title="Jonny Reeves">
      </a>
      <h1><a href="/">Jonny Reeves</a></h1>
      <p>code && coffee || music</p>
      <nav>
        <ul class="list">
        </ul>
      </nav>
      <ul class="social">
        <li><a class="sc-linkedin" href="https://br.linkedin.com/in/jonnyreeves/en" target="_blank"><i class="fa fa-linkedin"></i></a></li>
        <li><a class="sc-google" href="https://plus.google.com/+JohnReeves" target="_blank"><i class="fa fa-google"></i></a></li>
        <li><a class="sc-stack-overflow" href="http://stackoverflow.com/users/227349/jonnyreeves" target="_blank"><i class="fa fa-stack-overflow"></i></a></li>
        <li><a class="sc-github" href="https://github.com/jonnyreeves" target="_blank"><i class="fa fa-github"></i></a></li>
      </ul>
    </div>
  </aside>
  <main>

<article>
  <header>
    <h1 id="injecting-into-methods-with-typescript-decorators">Injecting into Methods with TypeScript Decorators</h1>
    <p>Posted on Mon 03 August 2015</p>
  </header>
  <div>
    <p>Expanding upon my <a href="/2015/basic-typescript-dependency-injection-with-decorators/">last post on Property based Dependency Injection</a>, let's have a look at what we need to do in order to inject into methods - here's what we want to achieve:</p>
<div class="highlight"><pre><span></span><span class="kr">class</span> <span class="nx">Person</span> <span class="p">{</span>
  <span class="kr">private</span> <span class="nx">_firstName</span> : <span class="kt">string</span><span class="p">;</span>
  <span class="kr">private</span> <span class="nx">_lastName</span> : <span class="kt">string</span><span class="p">;</span>

  <span class="kd">@inject</span><span class="p">(</span><span class="s1">&#39;firstName&#39;</span><span class="p">,</span> <span class="s1">&#39;lastName&#39;</span><span class="p">)</span>
  <span class="nx">setName</span><span class="p">(</span><span class="nx">first</span> : <span class="kt">string</span><span class="p">,</span> <span class="nx">last</span> : <span class="kt">string</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_firstName</span> <span class="o">=</span> <span class="nx">first</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">_last</span> <span class="o">=</span> <span class="nx">last</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">getFullName</span><span class="p">()</span> <span class="o">:</span> <span class="kt">string</span> <span class="p">{</span>
    <span class="k">return</span> <span class="sb">`</span><span class="si">${</span><span class="nx">firstName</span><span class="si">}</span><span class="sb"> </span><span class="si">${</span><span class="nx">lastName</span><span class="si">}</span><span class="sb">`</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Here we are decorating the <code>Person#setName()</code> method with the <code>@inject</code> decorator and requesting the values mapped against the 'firstName' and 'lastName' injection keys from the Dependency Container - our test case would look something like this:</p>
<div class="highlight"><pre><span></span><span class="c1">// Setup the container</span>
<span class="nx">injector</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="s1">&#39;firstName&#39;</span><span class="p">,</span> <span class="s1">&#39;Jonny&#39;</span><span class="p">);</span>
<span class="nx">injector</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="s1">&#39;lastName&#39;</span><span class="p">,</span> <span class="s1">&#39;Reeves&#39;</span><span class="p">);</span>

<span class="c1">// Instantiate a Person, the container will apply the injections.</span>
<span class="kr">const</span> <span class="nx">jonny</span> <span class="o">=</span> <span class="nx">injector</span><span class="p">.</span><span class="nx">instantiate</span><span class="p">(</span><span class="nx">Person</span><span class="p">);</span>

<span class="c1">// Test it worked.</span>
<span class="k">if</span> <span class="p">(</span><span class="nx">jonny</span><span class="p">.</span><span class="nx">getFullName</span><span class="p">()</span> <span class="o">!==</span> <span class="s1">&#39;Jonny Reeves&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;expected jonny.getFullName() to be Jonny Reeves but was &#39;</span> <span class="o">+</span> <span class="nx">jonny</span><span class="p">.</span><span class="nx">getFullName</span><span class="p">());</span>
<span class="p">}</span>
</pre></div>


<p>First of all we need to modify our <code>@inject</code> decorator, originally it only expected a single argument (the <code>injectionKey</code>), as methods can take more than one argument we need to make use of <a href="">rest parameters</a> to accept any number of strings:</p>
<div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">inject</span><span class="p">(...</span><span class="nx">injectionKeys</span> : <span class="kt">Array</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</pre></div>


<p>We face a slightly tricker challenge in the fact that injecting values into methods requires us to inoke a method rather than just assinging a property on the target object, in the previous implementation the <code>__inject__</code> Object was a simple hash of property name to injectionKey, but in order to inovoke the target method with the injection values in the correct scope we will need access to the target object as well.  To group this data together I've created an <code>InjectionPoint</code> object and assign this as the new value in the <code>__inject__</code> map:</p>
<div class="highlight"><pre><span></span><span class="kd">function</span> <span class="nx">inject</span><span class="p">(...</span><span class="nx">injectionKeys</span> : <span class="kt">Array</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span> <span class="nx">recordInjection</span><span class="p">(</span><span class="nx">target</span> : <span class="kt">Object</span><span class="p">,</span> <span class="nx">decoratedPropertyName</span> : <span class="kt">string</span><span class="p">)</span> <span class="o">:</span> <span class="k">void</span> <span class="p">{</span>
    <span class="cm">/* ... */</span>

    <span class="nx">targetType</span><span class="p">.</span><span class="nx">__inject__</span><span class="p">[</span><span class="nx">decoratedPropertyName</span><span class="p">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">InjectionPoint</span><span class="p">(</span>
                                        <span class="nx">target</span><span class="p">,</span> <span class="nx">decoratedPropertyName</span><span class="p">,</span> <span class="nx">injectionKeys</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Now we're storing the <code>InjectionPoint</code> data we need to modify <code>Injector#instantiate()</code> to make use of it when invoked.  The first change is driven by the fact the target Class' <code>__inject__</code> property is a hash of propertyNames to <code>InjectionPoint</code>'s and that an <code>InjectionPoint</code> provides one or more injectionKeys (before it was a hash of propertyNames to a single injectionKey), <code>Injector#getInjectionValues()</code> makes light work of this returning a collection of values to be injected:</p>
<div class="highlight"><pre><span></span><span class="kr">class</span> <span class="nx">Injector</span> <span class="p">{</span>
  <span class="cm">/* ... */</span>

  <span class="kr">private</span> <span class="nx">getInjectionValues</span><span class="p">(</span><span class="nx">injectionPoint</span> : <span class="kt">InjectionPoint</span><span class="p">)</span> <span class="o">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">injectionPoint</span><span class="p">.</span><span class="nx">injectionKeys</span>
      <span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">key</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">valuesByInjectionKey</span><span class="p">[</span><span class="nx">key</span><span class="p">]);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Now we need to determine how these values should be injected (either via a property of the target object, or by invoking a method of the target object).  Seeing as the <code>InjectionPoint</code> has all the knowledge it needs to perform the correct injection I employed the <a href="http://c2.com/cgi/wiki?HollywoodPrinciple">Hollywood Principle</a> and added an <code>InjectionPoint#inject()</code> method which the <code>Injector</code> invokes:</p>
<div class="highlight"><pre><span></span><span class="kr">class</span> <span class="nx">InjectionPoint</span> <span class="p">{</span>
  <span class="cm">/* ... */</span>

  <span class="nx">inject</span><span class="p">(</span><span class="nx">values</span> : <span class="kt">Array</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">:</span> <span class="k">void</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="k">this</span><span class="p">.</span><span class="nx">_target</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">_decoratedPropertyName</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_target</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">_decoratedPropertyName</span><span class="p">].</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_target</span><span class="p">,</span> <span class="nx">values</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// Property injection can only use the first value.</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_target</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">_decoratedPropertyName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">values</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>As before, the code and unit tests can be found over at <a href="https://github.com/jonnyreeves/ts-prop-injection/tree/02-method-injection">github.com/jonnyreeves/ts-prop-injection</a> - I've also raised a pull request on the repo to highlight the changes: <a href="https://github.com/jonnyreeves/ts-prop-injection/pull/1">github.com/jonnyreeves/ts-prop-injection/pull/1</a>.</p>
  </div>
  <div class="tag-cloud">
    <p>
    </p>
  </div>
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'jonnyreeves';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</article>

    <footer>
      <p>&copy; Jonny Reeves </p>
<p>Built using <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a></p>    </footer>
  </main>
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-30309890-1', 'auto');
  ga('send', 'pageview');
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BlogPosting",
  "name": "Injecting into Methods with TypeScript Decorators",
  "headline": "Injecting into Methods with TypeScript Decorators",
  "datePublished": "2015-08-03 21:00:00+01:00",
  "dateModified": "",
  "author": {
    "@type": "Person",
    "name": "Jonny Reeves",
    "url": "https://jonnyreeves.co.uk/author/jonny-reeves.html"
  },
  "image": "/images/avatar.jpg",
  "url": "https://jonnyreeves.co.uk/2015/injecting-into-methods-with-typescript-decorators/",
  "description": "Expanding upon my last post on Property based Dependency Injection, let's have a look at what we need to do in order to inject into methods - here's what we want to achieve: class Person { private _firstName : string; private _lastName : string; @inject('firstName', 'lastName') setName(first : string, last : string) { this._firstName …"
}
</script></body>
</html>
<!DOCTYPE html>
<html lang="en">

<head>
  <link rel="stylesheet/less" type="text/css" href="http://jonnyreeves.co.uk/theme/css/style.less">
  <script src="http://jonnyreeves.co.uk/theme/js/less-1.5.0.min.js" type="text/javascript"></script>
  <!-- <link rel="stylesheet" type="text/css" href="http://jonnyreeves.co.uk/theme/css/style.css"> -->

  <link rel="stylesheet" type="text/css" href="http://jonnyreeves.co.uk/theme/css/pygments.css">
  <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=PT+Sans|PT+Serif|PT+Mono">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Jonny Reeves">
  <meta name="description" content="Posts and writings by Jonny Reeves">

  <link href="http://jonnyreeves.co.uk/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Jonny Reeves Full Atom Feed" />

<meta name="keywords" content="">

  <title>
Injecting into Methods with TypeScript Decorators  </title>

<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-30309890-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
</head>

<body>
  <aside>
    <div id="user_meta">
      <a href="http://jonnyreeves.co.uk">
        <img src="/images/avatar.jpg" alt="logo">
      </a>
      <h2><a href="http://jonnyreeves.co.uk">Jonny Reeves</a></h2>
      <p></p>
      <ul>
        <li><a href="http://github.com/jonnyreeves" target="_blank">Github</a></li>
        <li><a href="http://stackoverflow.com/users/227349/jonnyreeves" target="_blank">Stack Overflow</a></li>
        <li><a href="https://plus.google.com/+JohnReeves" target="_blank">+JonnyReeves</a></li>
      </ul>
    </div>
  </aside>

  <main>
    <header>
<p>Posted on Mon 03 August 2015</p>
    </header>

<article>
  <div class="article_title">
    <h2><a href="http://jonnyreeves.co.uk/2015/injecting-into-methods-with-typescript-decorators/">Injecting into Methods with TypeScript Decorators</a></h2>
  </div>
  <div class="article_text">
    <p>Expanding upon my <a href="http://localhost:8000/2015/basic-typescript-dependency-injection-with-decorators/">last post on Property based Dependency Injection</a>, let's have a look at what we need to do in order to inject into methods - here's what we want to achieve:</p>
<div class="highlight"><pre>class Person {
  private _firstName : string;
  private _lastName : string;

  @inject(&#39;firstName&#39;, &#39;lastName&#39;)
  setName(first : string, last : string) {
    this._firstName = first;
    this._last = last;
  }

  getFullName() : string {
    return `<span class="cp">${</span><span class="n">firstName</span><span class="cp">}</span> <span class="cp">${</span><span class="n">lastName</span><span class="cp">}</span>`
  }
}
</pre></div>


<p>Here we are decorating the <code>Person#setName()</code> method with the <code>@inject</code> decorator and requesting the values mapped against the 'firstName' and 'lastName' injection keys from the Dependency Container - our test case would look something like this:</p>
<div class="highlight"><pre>// Setup the container
injector.map(&#39;firstName&#39;, &#39;Jonny&#39;);
injector.map(&#39;lastName&#39;, &#39;Reeves&#39;);

// Instantiate a Person, the container will apply the injections.
const jonny = injector.instantiate(Person);

// Test it worked.
if (jonny.getFullName() !== &#39;Jonny Reeves&#39;) {
    throw new Error(&#39;expected jonny.getFullName() to be Jonny Reeves but was &#39; + jonny.getFullName());
}
</pre></div>


<p>First of all we need to modify our <code>@inject</code> decorator, originally it only expected a single argument (the <code>injectionKey</code>), as methods can take more than one argument we need to make use of <a href="">rest parameters</a> to accept any number of strings:</p>
<div class="highlight"><pre><span class="kd">function</span> <span class="nx">inject</span><span class="p">(...</span><span class="nx">injectionKeys</span> <span class="o">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="nx">string</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</pre></div>


<p>We face a slightly tricker challenge in the fact that injecting values into methods requires us to inoke a method rather than just assinging a property on the target object, in the previous implementation the <code>__inject__</code> Object was a simple hash of property name to injectionKey, but in order to inovoke the target method with the injection values in the correct scope we will need access to the target object as well.  To group this data together I've created an <code>InjectionPoint</code> object and assign this as the new value in the <code>__inject__</code> map:</p>
<div class="highlight"><pre><span class="kd">function</span> <span class="nx">inject</span><span class="p">(...</span><span class="nx">injectionKeys</span> <span class="o">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="nx">string</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span> 
  <span class="k">return</span> <span class="kd">function</span> <span class="nx">recordInjection</span><span class="p">(</span><span class="nx">target</span> <span class="o">:</span> <span class="nb">Object</span><span class="p">,</span> <span class="nx">decoratedPropertyName</span> <span class="o">:</span> <span class="nx">string</span><span class="p">)</span> <span class="o">:</span> <span class="k">void</span> <span class="p">{</span>
    <span class="cm">/* ... */</span>

    <span class="nx">targetType</span><span class="p">.</span><span class="nx">__inject__</span><span class="cp">[</span><span class="nx">decoratedPropertyName</span><span class="cp">]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">InjectionPoint</span><span class="p">(</span>
                                        <span class="nx">target</span><span class="p">,</span> <span class="nx">decoratedPropertyName</span><span class="p">,</span> <span class="nx">injectionKeys</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Now we're storing the <code>InjectionPoint</code> data we need to modify <code>Injector#instantiate()</code> to make use of it when invoked.  The first change is driven by the fact the target Class' <code>__inject__</code> property is a hash of propertyNames to <code>InjectionPoint</code>'s and that an <code>InjectionPoint</code> provides one or more injectionKeys (before it was a hash of propertyNames to a single injectionKey), <code>Injector#getInjectionValues()</code> makes light work of this returning a collection of values to be injected:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="n">Injector</span> {
  /* ... */

  <span class="n">private</span> <span class="n">getInjectionValues</span>(<span class="n">injectionPoint</span> : <span class="n">InjectionPoint</span>) : <span class="nb">Array</span><span class="s">&lt;any&gt;</span> {
    <span class="k">return</span> <span class="n">injectionPoint</span>.<span class="n">injectionKeys</span>
      .<span class="nb">map</span>(<span class="nb">key</span> =&gt; <span class="n">this</span>.<span class="n">valuesByInjectionKey</span>[<span class="nb">key</span>]);
  }
}
</pre></div>


<p>Now we need to determine how these values should be injected (either via a property of the target object, or by invoking a method of the target object).  Seeing as the <code>InjectionPoint</code> has all the knowledge it needs to perform the correct injection I employed the <a href="http://c2.com/cgi/wiki?HollywoodPrinciple">Hollywood Principle</a> and added an <code>InjectionPoint#inject()</code> method which the <code>Injector</code> invokes:</p>
<div class="highlight"><pre><span class="kr">class</span> <span class="nx">InjectionPoint</span> <span class="p">{</span>
  <span class="cm">/* ... */</span>

  <span class="nx">inject</span><span class="p">(</span><span class="nx">values</span> <span class="o">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">:</span> <span class="k">void</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="k">this</span><span class="p">.</span><span class="nx">_target</span><span class="cp">[</span><span class="nx">this._decoratedPropertyName</span><span class="cp">]</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_target</span><span class="cp">[</span><span class="nx">this._decoratedPropertyName</span><span class="cp">]</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">_target</span><span class="p">,</span> <span class="nx">values</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="c1">// Property injection can only use the first value.</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">_target</span><span class="cp">[</span><span class="nx">this._decoratedPropertyName</span><span class="cp">]</span> <span class="o">=</span> <span class="nx">values</span><span class="cp">[</span><span class="mi">0</span><span class="cp">]</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>As before, the code and unit tests can be found over at <a href="https://github.com/jonnyreeves/ts-prop-injection/tree/02-method-injection">github.com/jonnyreeves/ts-prop-injection</a> - I've also raised a pull request on the repo to highlight the changes: <a href="https://github.com/jonnyreeves/ts-prop-injection/pull/1">github.com/jonnyreeves/ts-prop-injection/pull/1</a>.</p>
  </div>
  <div class="article_meta">
    <p>Category: <a href="http://jonnyreeves.co.uk/category/typescript.html">TypeScript</a></p>
  </div>


</article>

    <footer>
<p><a href="http://jonnyreeves.co.uk/" class="button_accent">&larr; Back to Index</a></p>
<script language="javascript">
    function toggleComments() {
        var commentDiv = document.getElementById("article_comments");
        (commentDiv.style.display == "none") ? commentDiv.style.display = "block" : commentDiv.style.display = "none";
        return false;
    }
</script>
    </footer>

    <div id="ending_message">
      <p>&copy; Jonny Reeves. Built using <a href="http://getpelican.com" target="_blank">Pelican</a>. Theme by Giulio Fidente on <a href="https://github.com/giulivo/pelican-svbhack" target="_blank">github</a>. .</p>
    </div>
  </main>
</body>
</html>
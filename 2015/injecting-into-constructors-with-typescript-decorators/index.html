<!DOCTYPE html>
<html lang="en">

<head>
  <link rel="stylesheet/less" type="text/css" href="http://jonnyreeves.co.uk/theme/css/style.less">
  <script src="http://jonnyreeves.co.uk/theme/js/less-1.5.0.min.js" type="text/javascript"></script>
  <!-- <link rel="stylesheet" type="text/css" href="http://jonnyreeves.co.uk/theme/css/style.css"> -->

  <link rel="stylesheet" type="text/css" href="http://jonnyreeves.co.uk/theme/css/pygments.css">
  <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=PT+Sans|PT+Serif|PT+Mono">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="author" content="Jonny Reeves">
  <meta name="description" content="Posts and writings by Jonny Reeves">

  <link href="http://jonnyreeves.co.uk/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Jonny Reeves Full Atom Feed" />

<meta name="keywords" content="">

  <title>
Injecting into Constructors with TypeScript Decorators  </title>

<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-30309890-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
</head>

<body>
  <aside>
    <div id="user_meta">
      <a href="http://jonnyreeves.co.uk">
        <img src="/images/avatar.jpg" alt="logo">
      </a>
      <h2><a href="http://jonnyreeves.co.uk">Jonny Reeves</a></h2>
      <p></p>
      <ul>
        <li><a href="http://github.com/jonnyreeves" target="_blank">Github</a></li>
        <li><a href="http://stackoverflow.com/users/227349/jonnyreeves" target="_blank">Stack Overflow</a></li>
        <li><a href="https://plus.google.com/+JohnReeves" target="_blank">+JonnyReeves</a></li>
      </ul>
    </div>
  </aside>

  <main>
    <header>
<p>Posted on Thu 06 August 2015</p>
    </header>

<article>
  <div class="article_title">
    <h2><a href="http://jonnyreeves.co.uk/2015/injecting-into-constructors-with-typescript-decorators/">Injecting into Constructors with TypeScript Decorators</a></h2>
  </div>
  <div class="article_text">
    <p>In the <a href="/2015/injecting-into-methods-with-typescript-decorators/">previous post</a> I added support for injecting into methods; this post provides the last missing InjectionPoint, constructor injection.  As with <a href="http://pierrechamberlain.ca/blog/2011/04/custom_metadata/">AS3 Metadata</a>, you can't annotate the <code>#constructor()</code> method directly:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="n">MyClass</span> {

  // <span class="n">Although</span> <span class="n">this</span> <span class="n">would</span> <span class="n">be</span> <span class="n">the</span> <span class="n">preferred</span> <span class="n">syntax</span> <span class="n">it</span> <span class="k">will</span> <span class="n">throw</span> <span class="n">a</span> <span class="n">compiler</span> <span class="n">error</span>,<span class="sr"></span>
<span class="sr">  //</span> <span class="n">TS1206:</span> <span class="n">Decorators</span> <span class="n">are</span> <span class="nb">not</span> <span class="n">valid</span> <span class="n">here</span>.
  <span class="nv">@inject</span>(<span class="s">&#39;firstName&#39;</span>)
  <span class="n">constructor</span>(<span class="nb">name</span> : <span class="n">string</span>) { ... }
}
</pre></div>


<p>Instead, we need to add the decorator to the Class, ie:</p>
<div class="highlight"><pre>@inject(&#39;firstName&#39;)
class MyClass {
  constructor(name : string) { ... }
}
</pre></div>


<p>This is slightly awkward as it moves our decorator away from the constructor declaration which contains our injection arguments - that's somewhat compounded by the fact constructor injection is the most desirable form of the three (constructor, method and property) as it promotes immutability by ensuring an object has all of its dependencies when constructed - still, at least it works :)</p>
<p>The first change is to the <code>@inject</code> decorator, previously we expected the first argument to the decoratorFactory (<code>target</code>) to be the instance of the Class being decorated; however because we are decorating the class itself, the decoratorFactory can't be invoked with the instance, instead it receives a reference to the Class' constructor function, likewise it does not receive a <code>decoratedPropertyName</code> argument.:</p>
<div class="highlight"><pre><span class="kd">function</span> <span class="nx">inject</span><span class="p">(...</span><span class="nx">injectionKeys</span> <span class="o">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="nx">string</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span> <span class="nx">decoratorFactory</span><span class="p">(</span><span class="nx">target</span> <span class="o">:</span> <span class="nb">Object</span><span class="o">|</span><span class="nb">Function</span><span class="p">,</span> <span class="nx">decoratedPropertyName</span><span class="o">?</span> <span class="o">:</span> <span class="nx">string</span><span class="p">)</span> <span class="o">:</span> <span class="k">void</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">targetType</span> <span class="o">:</span> <span class="nb">Function</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">target</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">decoratedPropertyName</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">targetType</span> <span class="o">=</span> <span class="nx">target</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nx">targetType</span> <span class="o">=</span> <span class="nx">target</span><span class="p">.</span><span class="nx">constructor</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* ... */</span>
<span class="p">}</span>
</pre></div>


<p>Next we need to record the <code>injectionKeys</code> that the user wants to be used to fulfill the constructor's dependencies - our <code>InjectionPoint</code> object is currently used to record dependencies, however it doesn't really fit for recording a constructor's dependencies:</p>
<ul>
<li><code>InjectionPoint#constructor()</code> takes three arguments, the target instance, decorated property name and a list of injectionKeys, but there is no target instance for a decorated constructor (we just get a reference to the Constructor function), and the decoratorFactory also does not receive a decoratedPropertyName argument.</li>
<li><code>InjectionPoint#inject()</code> is expected to perform the injection against the target instance, but we need to Construct a new instance (and return it)</li>
</ul>
<p>To deal with these special cases I ended up creating the <code>ConstructorInjectionPoint</code> class which specialises <code>InjectionPoint</code> to deal with the issues outlined above:</p>
<div class="highlight"><pre>export class ConstructorInjectionPoint extends InjectionPoint{
    constructor(injectionKeys : Array&lt;string&gt;) {
        super(null, &#39;constructor&#39;, injectionKeys);
    }

    inject(values : Array&lt;any&gt;) : void {
        throw new Error(&#39;Unsupported operation #inject()&#39;);
    }
}
</pre></div>


<p>This style of specialisation is not ideal; the worst offender is that <code>ConstructorInjectionPoint#inject()</code> throws an unsupported operation error - this design leads to a violation of the Liskov Substitution Principle (all sub-types should be interchangeable with their parent type) so it's something I plan to come back and revisit at a later date. </p>
<p>The decorator can now create the appropriate <code>InjectionPoint</code> type based on the arguments it receives</p>
<div class="highlight"><pre><span class="kd">function</span> <span class="nx">inject</span><span class="p">(...</span><span class="nx">injectionKeys</span> <span class="o">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="nx">string</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span> <span class="nx">decoratorFactory</span><span class="p">(</span><span class="nx">target</span> <span class="o">:</span> <span class="nb">Object</span><span class="o">|</span><span class="nb">Function</span><span class="p">,</span> <span class="nx">decoratedPropertyName</span><span class="o">?</span> <span class="o">:</span> <span class="nx">string</span><span class="p">)</span> <span class="o">:</span> <span class="k">void</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">targetType</span> <span class="o">:</span> <span class="nb">Function</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">injectionPoint</span> <span class="o">:</span> <span class="nx">InjectionPoint</span><span class="p">;</span>

    <span class="c1">// Decorator applied to Class (for Constructor injection).</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">target</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">decoratedPropertyName</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">targetType</span> <span class="o">=</span> <span class="nx">target</span><span class="p">;</span>
      <span class="nx">injectionPoint</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ConstructorInjectionPoint</span><span class="p">(</span><span class="nx">injectionKeys</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Decorator applied to member (method or property).</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">target</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">decoratedPropertyName</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">targetType</span> <span class="o">=</span> <span class="nx">target</span><span class="p">.</span><span class="nx">constructor</span><span class="p">;</span>
      <span class="nx">injectionPoint</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">InjectionPoint</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">decoratedPropertyName</span><span class="p">,</span> <span class="nx">injectionKeys</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">targetType</span><span class="p">.</span><span class="nx">__inject__</span><span class="cp">[</span><span class="nx">injectionPoint.propertyName</span><span class="cp">]</span> <span class="o">=</span> <span class="nx">injectionPoint</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>Now that the <code>ConstructorInjectionPoint</code> is being recorded, we need to modify <code>Injector#instantiate()</code> to make use of it when creating the resulting instance:</p>
<div class="highlight"><pre><span class="k">class</span> <span class="n">Injector</span> {
  <span class="n">instantiate</span><span class="s">&lt;T&gt;(Class : Constructable&lt;T&gt;</span>) : <span class="n">T</span> {
    // <span class="n">Create</span> <span class="n">an</span> <span class="n">instance</span> <span class="k">of</span> <span class="n">the</span> <span class="n">target</span> <span class="nb">Class</span> <span class="n">applying</span> <span class="n">the</span> <span class="n">Constructor</span> <span class="n">InjectionPoint</span> <span class="k">if</span> <span class="n">it</span> <span class="k">has</span> <span class="nb">one</span>.
    <span class="n">const</span> <span class="n">instance</span> : <span class="n">T</span> = <span class="n">this</span>.<span class="n">createInjecteeInstance</span>(<span class="nb">Class</span>);
    /* ... <span class="n">apply</span> <span class="n">property</span> <span class="o">and</span> <span class="k">method</span> <span class="n">injection</span> <span class="n">points</span> ... */
    <span class="k">return</span> <span class="n">instance</span>;
  }

  <span class="n">private</span> <span class="n">createInjecteeInstance</span><span class="s">&lt;T&gt;(Class : { new(...args : Array&lt;any&gt;</span>) : <span class="n">T</span> }) : <span class="n">T</span> {
    <span class="k">let</span> <span class="n">result</span> : <span class="n">T</span>;

    <span class="k">if</span> (<span class="nb">Class</span>.<span class="n">hasOwnProperty</span>(<span class="s">&#39;__inject__&#39;</span>)) {
      <span class="n">const</span> <span class="n">injectionPoint</span> : <span class="n">InjectionPoint</span> = (<span class="s">&lt;InjectionTarget&gt;</span> <span class="nb">Class</span>).<span class="n">__inject__</span>.<span class="n">constructor</span>];

      <span class="k">if</span> (<span class="n">injectionPoint</span>) {
        <span class="n">result</span> = <span class="n">invokeConstructor</span>(<span class="nb">Class</span>, <span class="n">this</span>.<span class="n">getInjectionValues</span>(<span class="n">injectionPoint</span>));
      }
    }

    // <span class="n">If</span> <span class="n">no</span> <span class="n">Constructor</span> <span class="n">InjectionPoint</span> <span class="k">is</span> <span class="n">found</span> <span class="k">return</span> <span class="n">a</span> <span class="nb">new</span> <span class="n">instance</span> <span class="n">with</span> <span class="n">no</span> <span class="n">arguments</span>.
    <span class="k">return</span> <span class="n">result</span> || <span class="nb">new</span> <span class="nb">Class</span>();
  }
}
</pre></div>


<p>The <code>invokeConstructor()</code> is a necessary evil that crops up in a lot of languages where you wish to call a constructor function with the <code>new</code> keyword.  Note that you can't make use of <code>Function.apply</code> here as there is no valid scope to pass (the scope is the new instance!), as a result we end up with this familiar pattern, the pyramid of doom:</p>
<div class="highlight"><pre><span class="kd">function</span> <span class="nx">invokeConstructor</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">Class</span> <span class="o">:</span> <span class="p">{</span> <span class="k">new</span><span class="p">(...</span><span class="nx">args</span> <span class="o">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">:</span> <span class="nx">T</span> <span class="p">},</span> <span class="nx">args</span> <span class="o">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">:</span> <span class="nx">T</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="mi">0</span><span class="o">:</span> <span class="k">return</span> <span class="k">new</span> <span class="nx">Class</span><span class="p">();</span>
        <span class="k">case</span> <span class="mi">1</span><span class="o">:</span> <span class="k">return</span> <span class="k">new</span> <span class="nx">Class</span><span class="p">(</span><span class="nx">args</span><span class="cp">[</span><span class="mi">0</span><span class="cp">]</span><span class="p">);</span>
        <span class="k">case</span> <span class="mi">2</span><span class="o">:</span> <span class="k">return</span> <span class="k">new</span> <span class="nx">Class</span><span class="p">(</span><span class="nx">args</span><span class="cp">[</span><span class="mi">0</span><span class="cp">]</span><span class="p">,</span> <span class="nx">args</span><span class="cp">[</span><span class="mi">1</span><span class="cp">]</span><span class="p">);</span>
        <span class="k">case</span> <span class="mi">3</span><span class="o">:</span> <span class="k">return</span> <span class="k">new</span> <span class="nx">Class</span><span class="p">(</span><span class="nx">args</span><span class="cp">[</span><span class="mi">0</span><span class="cp">]</span><span class="p">,</span> <span class="nx">args</span><span class="cp">[</span><span class="mi">1</span><span class="cp">]</span><span class="p">,</span> <span class="nx">args</span><span class="cp">[</span><span class="mi">2</span><span class="cp">]</span><span class="p">);</span>
        <span class="k">default</span><span class="o">:</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;I got bored...&quot;</span><span class="p">);</span>
    <span class="p">}</span>
</pre></div>


<p>As before I've pushed the code to <a href="https://github.com/jonnyreeves/ts-prop-injection/tree/03-ctor-injection">Github</a> and create a <a href="https://github.com/jonnyreeves/ts-prop-injection/pull/2">Pull Request</a> to highlight changes from the previous post.</p>
  </div>
  <div class="article_meta">
    <p>Category: <a href="http://jonnyreeves.co.uk/category/typescript.html">TypeScript</a></p>
  </div>


</article>

    <footer>
<p><a href="http://jonnyreeves.co.uk/" class="button_accent">&larr; Back to Index</a></p>
<script language="javascript">
    function toggleComments() {
        var commentDiv = document.getElementById("article_comments");
        (commentDiv.style.display == "none") ? commentDiv.style.display = "block" : commentDiv.style.display = "none";
        return false;
    }
</script>
    </footer>

    <div id="ending_message">
      <p>&copy; Jonny Reeves. Built using <a href="http://getpelican.com" target="_blank">Pelican</a>. Theme by Giulio Fidente on <a href="https://github.com/giulivo/pelican-svbhack" target="_blank">github</a>. .</p>
    </div>
  </main>
</body>
</html>
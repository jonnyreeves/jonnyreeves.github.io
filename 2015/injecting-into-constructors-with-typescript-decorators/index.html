<!DOCTYPE html>
<html lang="en">
<head>
  <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,400italic' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" type="text/css" href="https://jonnyreeves.co.uk/theme/css/style.min.css">
  <link rel="stylesheet" type="text/css" href="https://jonnyreeves.co.uk/theme/css/pygments.min.css">
  <link rel="stylesheet" type="text/css" href="https://jonnyreeves.co.uk/theme/css/font-awesome.min.css">
  <link href="https://jonnyreeves.co.uk/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Jonny Reeves Atom">
  <link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/images/favicon.ico" type="image/x-icon">

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />
<meta name="author" content="Jonny Reeves" />
<meta name="description" content="In the previous post I added support for injecting into methods; this post provides the last missing InjectionPoint, constructor injection. As with AS3 Metadata, you can't annotate the #constructor() method directly: class MyClass { // Although this would be the preferred syntax it will throw a compiler error, // TS1206: Decorators are not …" />
<meta name="keywords" content="">
<meta property="og:site_name" content="Jonny Reeves"/>
<meta property="og:title" content="Injecting into Constructors with TypeScript Decorators"/>
<meta property="og:description" content="In the previous post I added support for injecting into methods; this post provides the last missing InjectionPoint, constructor injection. As with AS3 Metadata, you can't annotate the #constructor() method directly: class MyClass { // Although this would be the preferred syntax it will throw a compiler error, // TS1206: Decorators are not …"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="https://jonnyreeves.co.uk/2015/injecting-into-constructors-with-typescript-decorators/"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2015-08-06 07:00:00+01:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="https://jonnyreeves.co.uk/author/jonny-reeves.html">
<meta property="article:section" content="TypeScript"/>
<meta property="og:image" content="/images/avatar.jpg">  <title>Jonny Reeves &ndash; Injecting into Constructors with TypeScript Decorators</title>
</head>
<body>
  <aside>
    <div>
      <a href="/">
        <img src="/images/avatar.jpg" alt="Jonny Reeves" title="Jonny Reeves">
      </a>
      <h1><a href="/">Jonny Reeves</a></h1>
      <p>code && coffee || music</p>
      <nav>
        <ul class="list">
        </ul>
      </nav>
      <ul class="social">
        <li><a class="sc-linkedin" href="https://br.linkedin.com/in/jonnyreeves/en" target="_blank"><i class="fa fa-linkedin"></i></a></li>
        <li><a class="sc-google" href="https://plus.google.com/+JohnReeves" target="_blank"><i class="fa fa-google"></i></a></li>
        <li><a class="sc-stack-overflow" href="http://stackoverflow.com/users/227349/jonnyreeves" target="_blank"><i class="fa fa-stack-overflow"></i></a></li>
        <li><a class="sc-github" href="https://github.com/jonnyreeves" target="_blank"><i class="fa fa-github"></i></a></li>
      </ul>
    </div>
  </aside>
  <main>

<article>
  <header>
    <h1 id="injecting-into-constructors-with-typescript-decorators">Injecting into Constructors with TypeScript Decorators</h1>
    <p>Posted on Thu 06 August 2015 in <a href="https://jonnyreeves.co.uk/category/typescript.html">TypeScript</a></p>
  </header>
  <div>
    <p>In the <a href="/2015/injecting-into-methods-with-typescript-decorators/">previous post</a> I added support for injecting into methods; this post provides the last missing InjectionPoint, constructor injection.  As with <a href="http://pierrechamberlain.ca/blog/2011/04/custom_metadata/">AS3 Metadata</a>, you can't annotate the <code>#constructor()</code> method directly:</p>
<div class="highlight"><pre><span></span><code><span class="kr">class</span> <span class="nx">MyClass</span> <span class="p">{</span>

  <span class="c1">// Although this would be the preferred syntax it will throw a compiler error,</span>
  <span class="c1">// TS1206: Decorators are not valid here.</span>
  <span class="kd">@inject</span><span class="p">(</span><span class="s1">&#39;firstName&#39;</span><span class="p">)</span>
  <span class="kr">constructor</span><span class="p">(</span><span class="nx">name</span> : <span class="kt">string</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>Instead, we need to add the decorator to the Class, ie:</p>
<div class="highlight"><pre><span></span><code><span class="kd">@inject</span><span class="p">(</span><span class="s1">&#39;firstName&#39;</span><span class="p">)</span>
<span class="kr">class</span> <span class="nx">MyClass</span> <span class="p">{</span>
  <span class="kr">constructor</span><span class="p">(</span><span class="nx">name</span> : <span class="kt">string</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>This is slightly awkward as it moves our decorator away from the constructor declaration which contains our injection arguments - that's somewhat compounded by the fact constructor injection is the most desirable form of the three (constructor, method and property) as it promotes immutability by ensuring an object has all of its dependencies when constructed - still, at least it works :)</p>
<p>The first change is to the <code>@inject</code> decorator, previously we expected the first argument to the decoratorFactory (<code>target</code>) to be the instance of the Class being decorated; however because we are decorating the class itself, the decoratorFactory can't be invoked with the instance, instead it receives a reference to the Class' constructor function, likewise it does not receive a <code>decoratedPropertyName</code> argument.:</p>
<div class="highlight"><pre><span></span><code><span class="kd">function</span> <span class="nx">inject</span><span class="p">(...</span><span class="nx">injectionKeys</span> : <span class="kt">Array</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span> <span class="nx">decoratorFactory</span><span class="p">(</span><span class="nx">target</span> : <span class="kt">Object</span><span class="o">|</span><span class="nb">Function</span><span class="p">,</span> <span class="nx">decoratedPropertyName?</span> : <span class="kt">string</span><span class="p">)</span> <span class="o">:</span> <span class="k">void</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">targetType</span> : <span class="kt">Function</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">target</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">decoratedPropertyName</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">targetType</span> <span class="o">=</span> <span class="nx">target</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="p">{</span>
      <span class="nx">targetType</span> <span class="o">=</span> <span class="nx">target</span><span class="p">.</span><span class="kr">constructor</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* ... */</span>
<span class="p">}</span>
</code></pre></div>

<p>Next we need to record the <code>injectionKeys</code> that the user wants to be used to fulfill the constructor's dependencies - our <code>InjectionPoint</code> object is currently used to record dependencies, however it doesn't really fit for recording a constructor's dependencies:</p>
<ul>
<li><code>InjectionPoint#constructor()</code> takes three arguments, the target instance, decorated property name and a list of injectionKeys, but there is no target instance for a decorated constructor (we just get a reference to the Constructor function), and the decoratorFactory also does not receive a decoratedPropertyName argument.</li>
<li><code>InjectionPoint#inject()</code> is expected to perform the injection against the target instance, but we need to Construct a new instance (and return it)</li>
</ul>
<p>To deal with these special cases I ended up creating the <code>ConstructorInjectionPoint</code> class which specialises <code>InjectionPoint</code> to deal with the issues outlined above:</p>
<div class="highlight"><pre><span></span><code><span class="kr">export</span> <span class="kr">class</span> <span class="nx">ConstructorInjectionPoint</span> <span class="kr">extends</span> <span class="nx">InjectionPoint</span><span class="p">{</span>
    <span class="kr">constructor</span><span class="p">(</span><span class="nx">injectionKeys</span> : <span class="kt">Array</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
        <span class="kr">super</span><span class="p">(</span><span class="kc">null</span><span class="p">,</span> <span class="s1">&#39;constructor&#39;</span><span class="p">,</span> <span class="nx">injectionKeys</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">inject</span><span class="p">(</span><span class="nx">values</span> : <span class="kt">Array</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">:</span> <span class="k">void</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">&#39;Unsupported operation #inject()&#39;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>This style of specialisation is not ideal; the worst offender is that <code>ConstructorInjectionPoint#inject()</code> throws an unsupported operation error - this design leads to a violation of the Liskov Substitution Principle (all sub-types should be interchangeable with their parent type) so it's something I plan to come back and revisit at a later date. </p>
<p>The decorator can now create the appropriate <code>InjectionPoint</code> type based on the arguments it receives</p>
<div class="highlight"><pre><span></span><code><span class="kd">function</span> <span class="nx">inject</span><span class="p">(...</span><span class="nx">injectionKeys</span> : <span class="kt">Array</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span> <span class="nx">decoratorFactory</span><span class="p">(</span><span class="nx">target</span> : <span class="kt">Object</span><span class="o">|</span><span class="nb">Function</span><span class="p">,</span> <span class="nx">decoratedPropertyName?</span> : <span class="kt">string</span><span class="p">)</span> <span class="o">:</span> <span class="k">void</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">targetType</span> : <span class="kt">Function</span><span class="p">;</span>
    <span class="kd">let</span> <span class="nx">injectionPoint</span> : <span class="kt">InjectionPoint</span><span class="p">;</span>

    <span class="c1">// Decorator applied to Class (for Constructor injection).</span>
    <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">target</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">decoratedPropertyName</span> <span class="o">===</span> <span class="kc">undefined</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">targetType</span> <span class="o">=</span> <span class="nx">target</span><span class="p">;</span>
      <span class="nx">injectionPoint</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ConstructorInjectionPoint</span><span class="p">(</span><span class="nx">injectionKeys</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Decorator applied to member (method or property).</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">target</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">decoratedPropertyName</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">targetType</span> <span class="o">=</span> <span class="nx">target</span><span class="p">.</span><span class="kr">constructor</span><span class="p">;</span>
      <span class="nx">injectionPoint</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">InjectionPoint</span><span class="p">(</span><span class="nx">target</span><span class="p">,</span> <span class="nx">decoratedPropertyName</span><span class="p">,</span> <span class="nx">injectionKeys</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">targetType</span><span class="p">.</span><span class="nx">__inject__</span><span class="p">[</span><span class="nx">injectionPoint</span><span class="p">.</span><span class="nx">propertyName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">injectionPoint</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>Now that the <code>ConstructorInjectionPoint</code> is being recorded, we need to modify <code>Injector#instantiate()</code> to make use of it when creating the resulting instance:</p>
<div class="highlight"><pre><span></span><code><span class="kr">class</span> <span class="nx">Injector</span> <span class="p">{</span>
  <span class="nx">instantiate</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">Class</span> : <span class="kt">Constructable</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">:</span> <span class="nx">T</span> <span class="p">{</span>
    <span class="c1">// Create an instance of the target Class applying the Constructor InjectionPoint if it has one.</span>
    <span class="kr">const</span> <span class="nx">instance</span> : <span class="kt">T</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">createInjecteeInstance</span><span class="p">(</span><span class="nx">Class</span><span class="p">);</span>
    <span class="cm">/* ... apply property and method injection points ... */</span>
    <span class="k">return</span> <span class="nx">instance</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="kr">private</span> <span class="nx">createInjecteeInstance</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">Class</span> <span class="o">:</span> <span class="p">{</span> <span class="k">new</span><span class="p">(...</span><span class="nx">args</span> : <span class="kt">Array</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">:</span> <span class="nx">T</span> <span class="p">})</span> <span class="o">:</span> <span class="nx">T</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">result</span> : <span class="kt">T</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">Class</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="s1">&#39;__inject__&#39;</span><span class="p">))</span> <span class="p">{</span>
      <span class="kr">const</span> <span class="nx">injectionPoint</span> : <span class="kt">InjectionPoint</span> <span class="o">=</span> <span class="p">(</span><span class="o">&lt;</span><span class="nx">InjectionTarget</span><span class="o">&gt;</span> <span class="nx">Class</span><span class="p">).</span><span class="nx">__inject__</span><span class="p">.</span><span class="kr">constructor</span><span class="p">];</span>

      <span class="k">if</span> <span class="p">(</span><span class="nx">injectionPoint</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">result</span> <span class="o">=</span> <span class="nx">invokeConstructor</span><span class="p">(</span><span class="nx">Class</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">getInjectionValues</span><span class="p">(</span><span class="nx">injectionPoint</span><span class="p">));</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// If no Constructor InjectionPoint is found return a new instance with no arguments.</span>
    <span class="k">return</span> <span class="nx">result</span> <span class="o">||</span> <span class="k">new</span> <span class="nx">Class</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>The <code>invokeConstructor()</code> is a necessary evil that crops up in a lot of languages where you wish to call a constructor function with the <code>new</code> keyword.  Note that you can't make use of <code>Function.apply</code> here as there is no valid scope to pass (the scope is the new instance!), as a result we end up with this familiar pattern, the pyramid of doom:</p>
<div class="highlight"><pre><span></span><code><span class="kd">function</span> <span class="nx">invokeConstructor</span><span class="o">&lt;</span><span class="nx">T</span><span class="o">&gt;</span><span class="p">(</span><span class="nx">Class</span> <span class="o">:</span> <span class="p">{</span> <span class="k">new</span><span class="p">(...</span><span class="nx">args</span> : <span class="kt">Array</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">:</span> <span class="nx">T</span> <span class="p">},</span> <span class="nx">args</span> : <span class="kt">Array</span><span class="o">&lt;</span><span class="nx">any</span><span class="o">&gt;</span><span class="p">)</span> <span class="o">:</span> <span class="nx">T</span> <span class="p">{</span>
    <span class="k">switch</span> <span class="p">(</span><span class="nx">args</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="nx">0</span>: <span class="kt">return</span> <span class="k">new</span> <span class="nx">Class</span><span class="p">();</span>
        <span class="k">case</span> <span class="nx">1</span>: <span class="kt">return</span> <span class="k">new</span> <span class="nx">Class</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
        <span class="k">case</span> <span class="nx">2</span>: <span class="kt">return</span> <span class="k">new</span> <span class="nx">Class</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
        <span class="k">case</span> <span class="nx">3</span>: <span class="kt">return</span> <span class="k">new</span> <span class="nx">Class</span><span class="p">(</span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nx">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
        <span class="k">default</span><span class="o">:</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;I got bored...&quot;</span><span class="p">);</span>
    <span class="p">}</span>
</code></pre></div>

<p>As before I've pushed the code to <a href="https://github.com/jonnyreeves/ts-prop-injection/tree/03-ctor-injection">Github</a> and create a <a href="https://github.com/jonnyreeves/ts-prop-injection/pull/2">Pull Request</a> to highlight changes from the previous post.</p>
  </div>
  <div class="tag-cloud">
    <p>
    </p>
  </div>
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'jonnyreeves';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
</article>

    <footer>
      <p>&copy; Jonny Reeves </p>
<p>Built using <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a></p>    </footer>
  </main>
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-30309890-1', 'auto');
  ga('send', 'pageview');
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BlogPosting",
  "name": "Injecting into Constructors with TypeScript Decorators",
  "headline": "Injecting into Constructors with TypeScript Decorators",
  "datePublished": "2015-08-06 07:00:00+01:00",
  "dateModified": "",
  "author": {
    "@type": "Person",
    "name": "Jonny Reeves",
    "url": "https://jonnyreeves.co.uk/author/jonny-reeves.html"
  },
  "image": "/images/avatar.jpg",
  "url": "https://jonnyreeves.co.uk/2015/injecting-into-constructors-with-typescript-decorators/",
  "description": "In the previous post I added support for injecting into methods; this post provides the last missing InjectionPoint, constructor injection. As with AS3 Metadata, you can't annotate the #constructor() method directly: class MyClass { // Although this would be the preferred syntax it will throw a compiler error, // TS1206: Decorators are not …"
}
</script></body>
</html>